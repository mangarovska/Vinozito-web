# docker-compose.yml - Vinozito Production Server Setup
# Domains: vinozito.accuai.live (frontend), vinozito-backend.accuai.live (backend)

version: '3.8'

services:
  # --- TRAEFIK - THE EDGE ROUTER ---
  traefik:
    image: "traefik:v3.0"
    container_name: "traefik"
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik-net
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "./traefik.yml:/etc/traefik/traefik.yml:ro"
      - "./acme.json:/acme.json"
    labels:
      - "traefik.enable=true"
      # Dashboard Router
      - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.vinozito.accuai.live`)"
      - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
      - "traefik.http.routers.traefik-dashboard.tls.certresolver=myresolver"
      - "traefik.http.routers.traefik-dashboard.service=api@internal"
      # Dashboard Middleware (Authentication)
      - "traefik.http.routers.traefik-dashboard.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=admin:$$apr1$$yLgB2bH3$$xS3q7kQ.fFq3y2D8m.yLw."

  # --- FRONTEND (React + Vite + Nginx) ---
  frontend:
    image: nnikolovskii/vinozito-frontend:1.0.0
    container_name: vinozito-frontend
    restart: unless-stopped
    environment:
      - REACT_APP_API_URL=https://vinozito-backend.accuai.live
    networks:
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend-router.rule=Host(`vinozito.accuai.live`)"
      - "traefik.http.routers.frontend-router.entrypoints=websecure"
      - "traefik.http.routers.frontend-router.tls.certresolver=myresolver"
      - "traefik.http.services.frontend-service.loadbalancer.server.port=80"

  # --- BACKEND API (.NET 9.0) ---
  backend:
    image: nnikolovskii/vinozito-backend:1.0.0
    container_name: vinozito-backend
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - MongoDB__ConnectionString=mongodb://vinozhito_db:${MONGO_PASSWORD}@mongodb:27017/?authSource=admin
      - MongoDB__DatabaseName=vinozitoDB
      - JwtSettings__Secret=${JWT_SECRET}
      - JwtSettings__Issuer=VinozitoApp
      - JwtSettings__Audience=VinozitoApp
      - FastAPI__InternalBaseUrl=${UPLOADER_URL:-http://uploader:5001}
      - FastAPI__Password=${UPLOADER_PASSWORD}
    networks:
      - traefik-net
    depends_on:
      mongodb:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend-router.rule=Host(`vinozito-backend.accuai.live`)"
      - "traefik.http.routers.backend-router.entrypoints=websecure"
      - "traefik.http.routers.backend-router.tls.certresolver=myresolver"
      - "traefik.http.services.backend-service.loadbalancer.server.port=8080"

  # --- MONGO EXPRESS - DATABASE UI ---
  mongo-express:
    image: mongo-express:1.0.2
    container_name: vinozito-mongo-express
    restart: unless-stopped
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: vinozhito_db
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_PASSWORD}
      ME_CONFIG_MONGODB_URL: mongodb://vinozhito_db:${MONGO_PASSWORD}@mongodb:27017/?authSource=admin
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: ${MONGO_EXPRESS_PASSWORD}
    networks:
      - traefik-net
    depends_on:
      mongodb:
        condition: service_healthy
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.db-router.rule=Host(`db.vinozito.accuai.live`)"
      - "traefik.http.routers.db-router.entrypoints=websecure"
      - "traefik.http.routers.db-router.tls.certresolver=myresolver"
      - "traefik.http.services.db-service.loadbalancer.server.port=8081"

  # --- MONGODB DATABASE ---
  mongodb:
    image: mongo:7.0
    container_name: vinozito-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: vinozhito_db
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASSWORD}
      MONGO_INITDB_DATABASE: vinozitoDB
    volumes:
      - mongodb_data:/data/db
    networks:
      - traefik-net
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  traefik-net:
    name: traefik-net

volumes:
  mongodb_data:
